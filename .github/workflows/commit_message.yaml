name: Add Branch Name as First Commit Message

on:
  push:
  workflow_dispatch:
    inputs:
      country:
        description: Cluster on which Locust runs
        required: true
        type: choice
        default: cluster1
        options:
          - cluster1
          - cluster2

env:
  CLUSTERS: |
    {
      "cluster1": "cluster-1",
      "cluster2": "cluster-2"
    }

jobs:
  cleanup-load-tests: 
    runs-on: ubuntu-latest
    env:
      CLUSTER: "teest"
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: true
    steps:
      - run: |
          echo "$CLUSTER" >> $GITHUB_STEP_SUMMARY
          echo "${{env.CLUSTERS}}" >> $GITHUB_STEP_SUMMARY
          
  husky:
    needs: cleanup-load-tests
    runs-on: ubuntu-latest
    steps:
    - name: Install husky
      run: |
        npm install husky --save-dev >> $GITHUB_STEP_SUMMARY
    - name: Download code
      uses: actions/checkout@v2
      
  add-commit-message:
    runs-on: ubuntu-latest
    needs:
    - cleanup-load-tests
    - husky
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get branch name
        id: get-branch-name
        #run: echo "::set-output name=branch-name::$(echo ${GITHUB_REF#refs/heads/} | sed -E 's/[^a-zA-Z0-9]+/-/g')"
        run: |
          echo "branch-name=$(echo ${GITHUB_REF#refs/heads/} | sed -nE 's#.*?([a-zA-Z]{3}-[0-9]{0,5})$#\1#p')" >> $GITHUB_OUTPUT
          echo "branch-name=$(echo ${GITHUB_REF#refs/heads/} | sed -nE 's#.*?([a-zA-Z]{3}-[0-9]{0,5})$#\1#p')" >> $GITHUB_STEP_SUMMARY
          echo "${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
