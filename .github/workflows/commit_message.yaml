name: Add Branch Name as First Commit Message

on:
  push:
  workflow_dispatch:
    inputs:
      country:
        description: Cluster on which Locust runs
        required: true
        type: choice
        default: germany
        options:
          - germany
          - belgium

env:
  CLUSTERS: |
    {
      "germany": "projects/db-dev-regt-olbcs-cluster/locations/europe-west3/clusters/olb-germany",
      "belgium": "projects/db-dev-regt-olbcs-cluster/locations/europe-west1/clusters/olb-belgium"
    }
  RELEASE_NAME: lpt
  NAMESPACE: load-tests

jobs:
  cleanup-load-tests: 
    runs-on: ubuntu-latest
    env:
      CLUSTER: fromJSON(env.CLUSTERS)[inputs.country]
      #${{ github.event_name == 'push' && 'projects/db-dev-regt-olbcs-cluster/locations/europe-west3/clusters/olb-germany' || fromJSON(env.CLUSTERS)[inputs.country] }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: true
    steps:
      - run: |
          echo "$CLUSTER" >> $GITHUB_STEP_SUMMARY

  husky:
    needs: cleanup-load-tests
    runs-on: ubuntu-latest
    steps:
    - name: Install husky
      run: |
        npm install husky --save-dev >> $GITHUB_STEP_SUMMARY
    - name: Download code
      uses: actions/checkout@v2
      
  add-commit-message:
    runs-on: ubuntu-latest
    needs:
    - cleanup-load-tests
    - husky
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get branch name
        id: get-branch-name
        #run: echo "::set-output name=branch-name::$(echo ${GITHUB_REF#refs/heads/} | sed -E 's/[^a-zA-Z0-9]+/-/g')"
        run: |
          echo "branch-name=$(echo ${GITHUB_REF#refs/heads/} | sed -nE 's#.*?([a-zA-Z]{3}-[0-9]{0,5})$#\1#p')" >> $GITHUB_OUTPUT
          echo "branch-name=$(echo ${GITHUB_REF#refs/heads/} | sed -nE 's#.*?([a-zA-Z]{3}-[0-9]{0,5})$#\1#p')" >> $GITHUB_STEP_SUMMARY
          echo "${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
